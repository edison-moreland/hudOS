load("@rules_foreign_cc//foreign_cc:defs.bzl", "meson")

filegroup(
    name = "all_srcs",
    srcs = glob(["**"]),
)

meson(
    name = "wayland",
    lib_source = ":all_srcs",
    build_data = [
        "@com_github_edison_moreland_nreal_hud//third_party:meson_cross.txt",
        "@com_github_edison_moreland_nreal_hud//third_party/tools:wayland_scanner_tool",
        "@com_github_edison_moreland_nreal_hud//third_party/tools:wayland_scanner_tool.build",
    ],
    env = {
        "CROSSFILE": "$$(dirname $$EXT_BUILD_ROOT$$/$(location @com_github_edison_moreland_nreal_hud//third_party:meson_cross.txt))/meson_cross.txt",
        "WAYLAND_PKG_CONFIG_PATH": "$$(dirname $$EXT_BUILD_ROOT$$/$(execpath @com_github_edison_moreland_nreal_hud//third_party/tools:wayland_scanner_tool))/../wayland_scanner_tool.build/lib/pkgconfig",
    },
    setup_args = [
        "--cross-file=$CROSSFILE",
        "--build.pkg-config-path=$WAYLAND_PKG_CONFIG_PATH"
    ],
    options = {
        "libraries": "true",
        "scanner": "false",
        "tests": "false",
        "documentation": "false",
        "dtd_validation": "false",
    },
    visibility = ["//visibility:public"],
    deps = [
        "@libffi",
    ],
    target_compatible_with = [
        "@platforms//cpu:aarch64",
        "@platforms//os:linux"
    ],
)